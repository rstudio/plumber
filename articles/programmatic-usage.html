<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Programmatic Usage • plumber</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Programmatic Usage">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">plumber</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/routing-and-input.html">Routing &amp; Input</a></li>
    <li><a class="dropdown-item" href="../articles/rendering-output.html">Rendering Output</a></li>
    <li><a class="dropdown-item" href="../articles/execution-model.html">Runtime</a></li>
    <li><a class="dropdown-item" href="../articles/security.html">Security</a></li>
    <li><a class="dropdown-item" href="../articles/hosting.html">Hosting</a></li>
    <li><a class="dropdown-item" href="../articles/programmatic-usage.html">Programmatic Usage</a></li>
    <li><a class="dropdown-item" href="../articles/annotations.html">Annotations reference</a></li>
    <li><a class="dropdown-item" href="../articles/tips-and-tricks.html">Tips &amp; Tricks</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration Guide</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2021/03/29/plumber-v1-1-0/">Version 1.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/plumber/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Programmatic Usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/plumber/blob/main/vignettes/programmatic-usage.Rmd" class="external-link"><code>vignettes/programmatic-usage.Rmd</code></a></small>
      <div class="d-none name"><code>programmatic-usage.Rmd</code></div>
    </div>

    
    
<p>Typically, users define APIs using the “annotations,” or special
comments in their API source code. It is possible to define a Plumber
API programmatically using the same underlying R6 objects that get
created automatically when you define your API using annotations.
Interacting with Plumber at this level can offer more control and
specificity about how you want your API to behave.</p>
<div class="section level2">
<h2 id="creating-and-controlling-a-router">Creating and Controlling a Router<a class="anchor" aria-label="anchor" href="#creating-and-controlling-a-router"></a>
</h2>
<p>The centerpiece of Plumber is the router. Plumber routers are
responsible for coordinating incoming requests from httpuv, dispatching
the requests to the appropriate filters/endpoints, serializing the
response, and handling errors that might pop up along the way. If you’ve
been using annotations to define Plumber APIs, then you’ve already
worked with Plumber routers as that’s what the <code><a href="../reference/plumb.html">plumb()</a></code>
command produces.</p>
<p>To instantiate a new Plumber router programmatically, you can call
<code><a href="../reference/pr.html">pr()</a></code>. This will return a blank Plumber router with no
endpoints. You could call <code><a href="../reference/pr_run.html">pr_run()</a></code> on the returned object
to start the API, but it doesn’t know how to respond to any requests so
any incoming traffic would get a <code>404</code> response. We’ll see
momentarily how to add endpoints and filters onto this empty router.
Alternatively, you can pass a file that contains your annotation-based
Plumber API as the first parameter to create a router much like you do
with <code><a href="../reference/plumb.html">plumb()</a></code>.</p>
<p>Be aware that Plumber routers do come with a handful of filters
pre-configured. These built-in filters are used to do things like
process properties of the incoming request like its cookies,
<code>POST</code> body, or query string. You can specify which filters
you want in your new router by overriding the <code>filters</code>
parameter when creating your new router.</p>
</div>
<div class="section level2">
<h2 id="defining-endpoints">Defining Endpoints<a class="anchor" aria-label="anchor" href="#defining-endpoints"></a>
</h2>
<p>You can define endpoints on your router by using the
<code><a href="../reference/pr_handle.html">pr_handle()</a></code>, <code><a href="../reference/pr_handle.html">pr_get()</a></code>, or
<code><a href="../reference/pr_handle.html">pr_post()</a></code>. For instance, to define a Plumber API that
response to <code>GET</code> requests on <code>/</code> and
<code>POST</code> requests on <code>/submit</code>, you could use the
following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># ...</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_handle.html">pr_post</a></span><span class="op">(</span><span class="st">"/submit"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># ...</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The “handler” functions that you define in these calls are identical
to the code you would have defined in your <code>plumber.R</code> file
if you were using annotations to define your API.</p>
<p>The route methods take additional arguments that allow you to control
nuanced behavior of the endpoint like which filter it might preempt or
which serializer it should use. For instance, the following endpoint
would use Plumber’s HTML serializer.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="st">"&lt;html&gt;&lt;h1&gt;Programmatic Plumber!&lt;/h1&gt;&lt;/html&gt;"</span></span>
<span>  <span class="op">}</span>, serializer <span class="op">=</span> <span class="fu">plumber</span><span class="fu">::</span><span class="fu"><a href="../reference/serializers.html">serializer_html</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="defining-filters">Defining Filters<a class="anchor" aria-label="anchor" href="#defining-filters"></a>
</h2>
<p>Use the <code><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter()</a></code> method of a Plumber router to define a
new filter:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_filter.html">pr_filter</a></span><span class="op">(</span><span class="st">"myFilter"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">req</span><span class="op">$</span><span class="va">filtered</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="fu"><a href="../reference/forward.html">forward</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Am I filtered?"</span>, <span class="va">req</span><span class="op">$</span><span class="va">filtered</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>You can specify other options such as the serializer to use if the
filter returns a value in the <code><a href="../reference/pr_filter.html">pr_filter()</a></code> method, as
well.</p>
</div>
<div class="section level2">
<h2 id="router-hooks">Registering Hooks on a Router<a class="anchor" aria-label="anchor" href="#router-hooks"></a>
</h2>
<p>Plumber routers support the notion of “hooks” that can be registered
to execute some code at a particular point in the lifecycle of a
request. Plumber routers currently support four hooks:</p>
<ul>
<li><code>preroute(data, req, res)</code></li>
<li><code>postroute(data, req, res, value)</code></li>
<li><code>preserialize(data, req, res, value)</code></li>
<li><code>postserialize(data, req, res, value)</code></li>
</ul>
<p>In all of the above you have access to a disposable environment in
the <code>data</code> parameter that is created as a temporary data
store for each request. Hooks can store temporary data in these hooks
that can be reused by other hooks processing this same request.</p>
<p>One feature when defining hooks in Plumber routers is the ability to
modify the returned value. The convention for such hooks is: any
function that accepts a parameter named <code>value</code> is expected
to return the new value. This could be an unmodified version of the
value that was passed in, or it could be a mutated value. But in either
case, if your hook accepts a parameter named <code>value</code>,
whatever your hook returns will be used as the new value for the
response.</p>
<p>You can add hooks using the <code>pr_hook</code> method, or you can
add multiple hooks at once using the <code>pr_hooks</code> method which
takes a name list in which the names are the names of the hooks, and the
values are the handlers themselves.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_hook.html">pr_hook</a></span><span class="op">(</span><span class="st">"preroute"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Routing a request for"</span>, <span class="va">req</span><span class="op">$</span><span class="va">PATH_INFO</span>, <span class="st">"...\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_hook.html">pr_hooks</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    preserialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"About to serialize this value:"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Must return the value since we took one in. Here we're not choosing</span></span>
<span>      <span class="co"># to mutate it, but we could.</span></span>
<span>      <span class="va">value</span></span>
<span>    <span class="op">}</span>,</span>
<span>    postserialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"We serialized the value as:"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">body</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span> <span class="fl">123</span> <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Making a <code>GET</code> request to <code>/</code> will print out
various information from the three events for which we registered
hooks.</p>
</div>
<div class="section level2">
<h2 id="mount-static">Mounting &amp; Static File Routers<a class="anchor" aria-label="anchor" href="#mount-static"></a>
</h2>
<p>Plumber routers can be “nested” by mounting one into another using
the <code>mount()</code> method. This allows you to compartmentalize
your API by paths which is a great technique for decomposing large APIs
into smaller files.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">users</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="st">"users.R"</span><span class="op">)</span></span>
<span><span class="va">products</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="st">"products.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">root</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_mount.html">pr_mount</a></span><span class="op">(</span><span class="st">"/users"</span>, <span class="va">users</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_mount.html">pr_mount</a></span><span class="op">(</span><span class="st">"/products"</span>, <span class="va">products</span><span class="op">)</span></span>
<span></span>
<span><span class="va">root</span></span></code></pre></div>
<p>This is the same approach used for defining routers that serve a
directory of static files. Static file routers are just a special case
of Plumber routers created using <code><a href="../reference/pr_static.html">pr_static()</a></code>. For
example</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_static.html">pr_static</a></span><span class="op">(</span><span class="st">"/assets"</span>, <span class="st">"./myfiles"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pr_run.html">pr_run</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This will make the files and directories stored in the
<code>./myfiles</code> directory available on your API under the
<code>/assets/</code> path.</p>
</div>
<div class="section level2">
<h2 id="customize-router">Customizing a Router<a class="anchor" aria-label="anchor" href="#customize-router"></a>
</h2>
<p>There are a handful of useful methods to be aware of to modify the
behavior of a router. <a href="#router-hooks">Using hooks to alter
request processing</a> has already been discussed, but additionally you
can modify a router’s behavior using any of the following:</p>
<ul>
<li>
<code><a href="../reference/pr_set_serializer.html">pr_set_serializer()</a></code> - Sets the default serializer of
the router.</li>
<li>
<code><a href="../reference/pr_set_error.html">pr_set_error()</a></code> - Sets the error handler which gets
invoked if any filter or endpoint generates an error.</li>
<li>
<code><a href="../reference/pr_set_404.html">pr_set_404()</a></code> - Sets the handler that gets called if an
incoming request can’t be served by any filter, endpoint, or
sub-router.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="http://schloerke.com" class="external-link">Barret Schloerke</a>, <a href="https://trestletech.com/" class="external-link">Jeff Allen</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
